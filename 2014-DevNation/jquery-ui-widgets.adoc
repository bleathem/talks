= Hands on with the jQuery UI widget factory
Brian Leathem <https://github.com/brianleathem[@brianleathem]>
:backend: dzslides
:dzslides-transition: fade
:dzslides-aspect: 16-9
:dzslides-style: ../../../themes/devnation
:dzslides-highlight: github
:source-highlighter: highlightjs
:imagesdir: images
:linkattrs:

== The plan
[.side-by-side]
--
* jQuery Plugin review
* Widget factory advantages
* Use cases and examples

image::storm_troopers.jpg[Storm Troopers, alt="http://www.flickr.com/photos/jdhancock/5845280258/"]
--

[NOTE.details]
====
 * We're here to talk about building javascript widgets with the jQuery UI widget factory.
 * Using the familiar jQuery plugin pattern as a common starting point we'll look at
   some use cases where jQuery plugins fall short and discuss how the jquery widget factory helps us
   overcome those shortcomings.
 * Finally we'll do a deep-dive into an example widget and learn the widget factory conventions that help
   us keep our code clean and concise
====

== Who am I?
[.side-by-side]
--
image::silhouette.png[Silhouette, alt="http://leslycorazon.wikispaces.com/file/detail/head-silhouette-with-question-mark.png/319199232"]

* Brian Leathem
* Software Engineer @ Red Hat
* RichFaces project lead (JSF)
* RichWidgets -- http://richwidgets.io
--

[NOTE.details]
====
* My own experience with the widget factory comes from the work I've done leading the RichFaces JSF project
  over the past year in developing RichFaces 5
* Our goal with RichFaces 5 is to re-develop the front end of our JSF components as standalone javascript widgets
  that can be used either independently or backed by any web framework in any language
* We created the _richwidgets_ subproject to move that effort forward, and we chose the jquery ui widget factory
  as the vehicle for our implementation
====

== Who are you?
image::crowd.png[crowd, alt="http://openclipart.org/detail/crowd-by-kattekrab"]

[NOTE.details]
====
* And how about you guys, lets' get an idea of the audience we have here today?
* Can I see a show of hands
** from those in the audience who consider themselves proficient with javascript?
** And how about those of you who are familiar with the jquery plugin pattern?
====

[.topic]
== Tapping into the jQuery ecosystem

[NOTE.details]
====
* Great, with the introductions out of the way let's dive into the good stuff
====

== jQuery
[.side-by-side]
--
.Consistent cross browser API for:
* DOM traversal
* HTML Manipulation
* Event handling
* Animation
* Ajax

++++
<div>
++++
image::jquery.png[jquery, alt="http://brand.jquery.org/logos/"]
++++
</div>
++++

--

== jQuery API
[source,javascript]
----
$('some-selector').method(parameters);
----

++++
<br />
++++

.Example methods:
[.listingblock]
* `addClass / removeClass / css`
* `html / text`
* `bind`
* `animate`

== jQuery Ubiquity

image::jquery_usage.png[jquery usage, link="http://trends.builtwith.com/javascript/jQuery"]

[NOTE.details]

== jQuery Plugins
[.side-by-side]
--
* Extend jQuery with custom functionality
* Easy way to share code

[source,html]
----

<html>
  <p>Some text in a document</p>
</html>

...

<script>
  $('p').myplugin();
</script>
----

--

[NOTE.details]
====
* A new method that extends jQuery's prototype object
* Allow us to create custom code to interact with a set of elements
* De-facto standard, providing a module system for sharing code between projects
====

== A simple plugin

[.side-by-side]
--
[source,javascript]
----
(function( $ ) {
 $.fn.myplugin = function() {
  return this.each(function() {
   $(this)
    .addClass("some-class")
    .css("color", "red");
   });
 };
})( jQuery );
----

--

[NOTE.details]
====
* We have here before us a simple jquery plugin
* It consists of a function assignment into the jQuery object
====

[.center]
== Use cases
Well suited to use cases where plugin execution +
_results in some intended side-effect:_

* Text manipulation
* Animation
* Layout

[NOTE.details]
====
* Provide a means to manipulate a set of DOM objects
* jQuery plugins execute *once*
====

== A Stateful Widget
[.side-by-side]
--

* The active tab is the widget state
* Use the javascript API to cycle the active tab
+
++++
<div>
<button class='btn' onclick="var active = jQuery( '#tabs' ).tabs('option', 'active'); jQuery( '#tabs' ).tabs('option', 'active', (active + 1) % 3)" style="font-size: 30px; margin-top: 20px">Cycle Tabs</button>
<div>
++++

++++
<div>
<div id="tabs" class="live-demo" style="width: 400px; height: 234px;">
  <ul>
    <li><a href="#fragment-1"><span>One</span></a></li>
    <li><a href="#fragment-2"><span>Two</span></a></li>
    <li><a href="#fragment-3"><span>Three</span></a></li>
  </ul>
  <div id="fragment-1">
    <p>Instantiate the widget as a jQuery plugin:</p>
    <pre><code>$( "#tabs" ).tabs(); </code></pre>
  </div>
  <div id="fragment-2">
    <p class="javascript">Query the active tab using the <em>active</em> option:</p>
    <pre><code>jQuery('#tabs')
  .tabs('option', 'active');</code></pre>
  </div>
  <div id="fragment-3">
    <p class="javascript">Set the active tab with the same <em>active</em> option:</p>
    <pre><code>jQuery('#tabs')
  .tabs('option', 'active', value);</code></pre>
  </div>
</div>
<div>
++++
--

++++
<script>jQuery( '#tabs' ).tabs();</script>
++++

== Stateful plugins
[.side-by-side]
--
* Track & query state
* Mutate options
* Plugin interactions
* Reverse DOM changes
* Notify event listeners

[emphasis]#Widgets#
--

[NOTE.details]
====
* There are a number of concerns that are not addressed out-of-the box with the jQuery plugin syntax
* These include...
* Some examples of these include
====

== Widgets with OOP
[source, javascript]
----
( function( $ ) {
  function MyWidget( element ) {
    this.init( element );
  }
  MyWidget.prototype.init = ...
  MyWidget.prototype.destroy = ...
  MyWidget.prototype.addListener = ...
  MyWidget.prototype.removeListener = ...
  MyWidget.prototype.setOption = ...

  ...
----

[NOTE.details]
====
* This isn't to say there aren't jQuery plugins out there that track state
====

== OOP Plugins

[source, javascript]
----
( function( $ ) {
  ...

  $.fn.mywidget = function() {
    return this.each( function() {
      $.data( this, "mywidget", new MyWidget( this ) );
    });
  };
})( jQuery );
----

== Widget API with OOP

Interact with the widget via an API:

[source, javascript]
---- 
$(document).ready( function() {
  var widget = $( "#foo" ).mywidget().data( "mywidget" );
  widget.doSomething();
});
----

== OOP -> Boilerplate!

Encapsulate the boilerplate code in a common prototype function:
[source, javascript]
---- 
( function( $ ) {
  MyWidget.prototype = ...
  $.extend(MyWidget.prototype, myPrototype);
})(jQuery);
----

== OOP Advantages
[.side-by-side]
--
* Object instance
* API for interactions
* D.R.Y. w/ a Shared prototype

++++
<div>
<i class="fa fa-check-circle" style="font-size: 300px; color: #6dbcdb;"></i>
</div>
++++
--

== OOP Dis-advantages
[.side-by-side]
--
* Custom prototype maintenance
* Non-standard API
** events
** mutable options

++++
<div>
<i class="fa fa-times-circle" style="font-size: 300px; color: #fc5d47;"></i>
</div>
++++
--
[.topic]
== jQuery UI Widget Factory

== jQuery UI widget factory

[.side-by-side]
--
[.checks]
* Track & query state
* Mutate options
* Widget interactions
* Reverse DOM changes
* Notify event listeners

++++
<div class="center emphasis" style="width: 50%">Consistent<br />API</div>
++++
--

[NOTE.details]
====
The jQuery UI widget factory provides this shared prototype.
====

== Stopwatch example
[.side-by-side]
--
[source, javascript, role=center"]
----
jQuery('#timer').stopwatch();
----

image::stopwatch.jpg[Stopwatch, alt="http://www.flickr.com/photos/26782864@N00/3297205226/"]
--

== window.setInterval

[quote]
Calls a function or executes a code snippet repeatedly, with a fixed time delay between each call to that function.

[source, javascript]
----
window.setInterval( callback, interval );
----

[NOTE.details]
====
* The least interesting part of the example
====

== Stopwatch example

++++
<div id="timer" class="stopwatch">
    <div class="digits">10</div>
</div>
<p class='center'>
  <button class="btn" onclick="jQuery('#timer').stopwatch()">Execute</button>
</p>

<script>
//jQuery('#timer').stopwatch();
</script>
++++

== Stopwatch example

++++
<div id="timer2" class="stopwatch">
    <div class="digits">10</div>
</div>

<div class='center'>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('start')">Start</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('pause')">Pause</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('resume')">Resume</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('stop')">Stop</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('reset')">Reset</button>
</div>
<div class='center'>
  <button class="btn" onclick="jQuery('#timer2').stopwatch(window.richwidgets.timerOptions)">Execute</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('destroy')">Destroy</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('enable')">Enable</button>
  <button class="btn" onclick="jQuery('#timer2').stopwatch('disable')">Disable</button>
</div>
++++

++++
<script>
(function($) {
  var ready = '#428bca';
  var active = '#5cb85c';
  var waiting = '#f0ad4e';
  var stopped = '#d9534f';
  var originalBg = $('#timer').css('background-color');
  var originalColor = $('#timer').css('color');

  var options = {
    autostart: false,
    create: function(event, ui) {
      ui.element.css('background-color', ready);
      ui.element.css('color', 'white');
    },
    reset: function(event, ui) {
      ui.element.css('background-color', ready);
    },
    start: function(event, ui) {
      ui.element.css('background-color', active);
    },
    resume: function(event, ui) {
      ui.element.css('background-color', active);
    },
    pause: function(event, ui) {
      ui.element.css('background-color', waiting);
    },
    stop: function(event, ui) {
      ui.element.css('background-color', stopped);
    },
    destroy: function(event, ui) {
      ui.element.css('background-color', originalBg);
      ui.element.css('color', originalColor);
    }
  };

  window.richwidgets = window.richwidgets || {};
  window.richwidgets.timerOptions = options;

  $('#timer2').stopwatch(options);

})(jQuery);
</script>

++++

== Widget Factory Deep Dive

[.side-by-side]
--
[source, javascript, style="margin-left: 20px"]
---- 
(function($) {
  $.widget("rich.stopwatch", { 
    /** prototype object **/ 
  });
})(jQuery);
----

image::factory.jpg[Thunderbird assembly line, alt="http://commons.wikimedia.org/wiki/File:Thunderbird_assembly_line.jpg"]
--

== Anatomy of a widget
[source, javascript]
----
( function( $ ) {
  $.widget( "rich.stopwatch", {
    options: { ... }
    doSomething: function() {
      // public methods have no "_" prefix
    },
    _helper: function() {
      // private methods have an "_" prefix
    }
  });
})( jQuery );
----

== Default Options
[source, javascript]
----
( function( $ ) {
  $.widget( "rich.stopwatch", {

    options: {
      autostart: true,
      direction: 'decreasing',
      increment: 100 // in milliseconds
    },
    ...
  });
})( jQuery );
----

== Invoking Methods
Public methods:
[source, javascript]
----
$('#timer').stopwatch('doSomething', 'optionalParam');

// or

var widget = $('#timer').data('richStopwatch');
widget.doSomething();
----

== Invoking Methods
Private methods _are_ accessible:
[source, javascript]
----
var widget = $('#timer').data('richStopwatch');
widget._helper();
----

++++
<br />
++++

Accessible private methods helps with widget extension

== Lifecycle and callbacks

[.side-by-side]
--
image::cycle.png[lifecycle, alt="http://openclipart.org/detail/171954/cycle-color-by-karthikeyan-171954"]

* _create / _destroy
* disable / enable
* _setOption
* _trigger
--

[.center]
== Widget Initialisation
Optionally override the `_create` method

* Apply DOM changes
* Register event listeners
* _create_ event fired implicitly

== Create
[source, javascript]
---- 
_create: function() {
  this.digitsElement = this.element.find('.digits');
  this.startTime = this.digits();
  this.digits(this.startTime);
  if (this.options.autostart) {
    this._createInterval();
  }
  if (this.options.showProgressBar) {
    this._addProgressBar();
  }
},
----

== Widget Clean Up
[.side-by-side]
--
image::tidy.png[clean up, alt="http://openclipart.org/detail/90451/keep-tidy-outside-01-by-anonymous"]

* Leave the DOM as you found it
* Remove any event handlers
* Remove any timers/intervals
--

== Destroy!
[source, javascript]
----
_destroy: function() {
  this._removeInterval();
  if (this.progressBar) {
    this.progressBar.parents('.progress').first().remove();
  }
  this.digitsElement.text(this.startTime);
  this._trigger('destroy', undefined, this._dumpUi());
}
----

== Enable / Disable
[source, javascript]
----
$.widget = {  // the jQuery UI widget object
  ...
  enable: function() {
    return this._setOptions({ disabled: false });
  },

  disable: function() {
    return this._setOptions({ disabled: true });
  },

}
----

== Mutable Options
The widget Factory provides the `option` method for getting/setting the initialisation options

[source, javascript]
----
$('#timer').stopwatch('option', 'showProgressBar', false);
----

++++
<br />
++++
Hook in via the `_setOption` method if required

[NOTE.details]
====
* Alternatively you can get a reference to the widget object
** Some options have an implicit effect, eg. `increment`
** For other options some explicit action is required, eg. `showProgressBar`
====

== Mutable Options
[source, javascript]
----
_setOption: function (key, value) {
  var widget = this;
  if (this.options.key === value) {
    return;
  }
  switch (key) {
    ...
  }
  this._super(key, value);
},
----

== Mutable Options
[source, javascript]
----
case 'disabled':
  if (value === true) widget._disable();
  else widget._enable();
  break;
case 'showProgressBar':
  if (value === true && !widget.progressBar) {
    widget._addProgressBar();
  } else if (value === false && widget.progressBar) {
    widget._removeProgressBar();
  }
  break;
----

[NOTE.details]
====
* Point out the disabled implementation here
====

== Events & Callbacks
[.side-by-side]
--
* Events allow for object extension
* Callbacks provided as either:
  . plugin options
  . event listeners

image::party.png[Party, alt="http://openclipart.org/detail/181653/new-years-party-by-liftarn-181653"]
--

[NOTE.details]
====
* No list of callbacks to maintain and notify
====

== Callbacks as options

[.center]
Option name matches the event name:

[source, javascript]
----
var options = {
  ...

  create: function(event, ui) {
    ui.element.css('background-color', ready);
    ui.element.css('color', 'white');
  }
----

[NOTE.details]
====
* Option name matches the event name
* Discuss the ui parameter
====

== Callbacks as event listeners
jQuery event is prefixed with the event name

[source, javascript]
----
$('#timer').on('stopwatchcreate'), function(event, ui) {
  ui.element.css('background-color', ready);
  ui.element.css('color', 'white');
});
----

[NOTE.details]
====
* jQuery events are all lowercase
* Event name prefix is overridable with widgetEventPrefix
====

== Triggering events
Triggering events couldn't be any easier:
[source, javascript]
----
this._trigger('eventname', event, ui);
----

.Function Parameters:
* `event` usually propagates an observed event
* `ui` is an object that shares widget states

[NOTE.details]
====
* Consider checking the disabled state before triggering events
====

== The UI parameter
Consolidate `ui` object creation in a method

[source, javascript]
----
_dumpUi: function() {
  return {
    element: this.element,
    digits: this.digits()
  };
},
----

== A note on styling

Adopting the jQuery UI widget factory _does not_ tie you to the jQuery UI themes.

Examples in this demo were styled with:

[.center]
* Bootstrap (http://getbootstrap.com)
* less.js (http://lesscss.org/)

[.topic]
== Testing and Docs

== Testing
* http://pivotal.github.io/jasmine/[Jasmine] - BDD for javascript
* https://github.com/velesin/jasmine-jquery[Jasmine-jQuery] - API for handling DOMfixtures in your tests
* http://karma-runner.github.io/[Karma] - test runner

[NOTE.details]
====
* Jasmine is a behavior-driven development framework for testing JavaScript code
* Jasmine-jquery provides an API for handling HTML, CSS, and JSON fixtures in your specs
* Karma is the test runner, it controls the browser and executes the tests

====

== Jasmine Example

[source, javascript]
----
describe("The 'toBe' matcher compares with ===", function() {
  it("and has a positive case ", function() {
      expect(true).toBe(true);
    });
  it("and can have a negative case", function() {
      expect(false).not.toBe(true);
    });
});
----

[NOTE.details]
====
* Jasmine provides an API that provides us with a vocabulary for writing tests
====

== More on testing
Tomorrow at DevNation:
****
Mobile web development: workflow and best practices - Lukas Fryc (Room 208)
****

Testing in richwidgets:
****
https://github.com/richwidgets/richwidgets/blob/master/TESTS.md[github.com/richwidgets/richwidgets/blob/master/TESTS.md]
****


== API docs
YUIDoc can be used to provide generated API documentation

[source, javascript]
----
options: {
  /**
   * Whether to start the stopwatch on plugin execution
   *
   * @property autostart
   * @type Boolean
   * @default true
   */
  autostart: true,
----

[NOTE.details]
====
* Javadoc can be hard to give up
====

== Stopwatch API docs

****
link:/assets/api/classes/stopwatch.html[/assets/api/classes/stopwatch.html, window="API"]
****



[.topic]
== Stopwatch example

== !

[.scroll]
--
[source, javascript]
----
include::assets/stopwatch.js[]
----
--

== Credits
[.credits]
****
* http://www.flickr.com/photos/jdhancock/5845280258/
* http://leslycorazon.wikispaces.com/file/detail/head-silhouette-with-question-mark.png/319199232
* http://openclipart.org/detail/crowd-by-kattekrab
* http://brand.jquery.org/logos/
* http://www.flickr.com/photos/26782864@N00/3297205226/
* http://commons.wikimedia.org/wiki/File:Thunderbird_assembly_line.jpg
* http://openclipart.org/detail/171954/cycle-color-by-karthikeyan-171954
* http://openclipart.org/detail/90451/keep-tidy-outside-01-by-anonymous
* http://openclipart.org/detail/181653/new-years-party-by-liftarn-181653
****

++++
<div class='license'>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
  </a>
  <br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Hands on with the jQuery UI widget factory</span> by
  <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.bleathem.ca/talks/2014-DevNation/jquery-ui-widgets.html" property="cc:attributionName" rel="cc:attributionURL">Brian Leathem</a>
      is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
  <br />Based on a work at
  <a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/bleathem/talks/" rel="dct:source">https://github.com/bleathem/talks/</a>.
</div>
++++

== Learn More on jQuery UI
* https://api.jqueryui.com/jquery.widget/
* http://ajpiano.com/widgetfactory
* https://learn.jquery.com/jquery-ui/widget-factory/how-to-use-the-widget-factory/

++++
<br />
++++

* http://richwidgets.io

